# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π c –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ Zabbix

<!-- –°–∫–∞—á–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å –≥–∏—Ç–ª–∞–±–∞ -->

cd ~
git clone https://github.com/ableev/Zabbix-in-Telegram

<!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python -->

sudo apt install python3-pip
cd Zabbix-in-Telegram/
pip3 install -r requirements.txt

<!-- –ö–æ–ø–∏—Ä—É–µ–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /usr/lib/zabbix/alertscripts —Ñ–∞–π–ª—ã zbxtg.py –∏ zbxtg_settings.example.py –∏–∑ —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ —Å github –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –≤ zbxtg_settings.py. –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è zabbix –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —ç—Ç–∏—Ö —Ñ–∞–π–ª–æ–≤. -->

sudo mv zbxtg_settings.example.py zbxtg_settings.py
sudo cp zbxt\*.py /usr/lib/zabbix/alertscripts
chown -R zabbix. /usr/lib/zabbix/alertscripts

<!-- –ü—Ä–∏–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ zbxtg_settings.py –ø—Ä–∏–º–µ—Ä–Ω–æ –∫ —Ç–∞–∫–æ–º—É –≤–∏–¥—É. -->

tg_key = "1393668911:AAHtEDfgHJHYDVDwxKfvH1WR6-vdNw" # telegram bot api key
zbx_server = "http://127.0.0.1/zabbix/" # zabbix server full url
zbx_api_user = "Admin"
zbx_api_pass = "zabbix"
zbx_server_version = 4 # for Zabbix 4.x version, default will be changed in the future with this
zbx_db_host = "localhost"
zbx_db_database = "zabbix"
zbx_db_user = "root"
zbx_db_password = "123"

<!-- –ù–∞ 797 —Å—Ç—Ä–æ—á–∫–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–¥ -->

    if tg.type == "group":
        uid = zbx_to
    if tg.type == "private":
        zbx_to = zbx_to.replace("@", "")

<!-- –ü—Ä–æ–≤–µ—Ä–∏–º –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞. -->

/usr/lib/zabbix/alertscripts/zbxtg.py "-1001590367971" "—Ç–µ—Å—Ç" "—Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" --debug --group
sudo -u zabbix ./zbxtg.py "-1001590367971" test "$(echo -e 'zbxtg;graphs: \nzbxtg;graphs_period=3600\nzbxtg;itemid:3082\nzbxtg;title:ololo')" --debug --group

<!-- —Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –≤–º–µ—Å—Ç–æ python –Ω–∞–ø–∏—à–∏—Ç–µ python3: -->

#!/usr/bin/env python3

<!-- –¢–∞–∫ –∂–µ –Ω–∞–º –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –æ–ø–æ–≤–µ—â–µ–Ω–∏–π. –Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç. –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏–π –ü—Ä–æ–±–ª–µ–º–∞. -->

# –®–∞–±–ª–æ–Ω –ü—Ä–æ–±–ª–µ–º–∞

{{WARNING}} {HOST.NAME} - {TRIGGER.STATUS}

zbxtg;graphs
zbxtg;graphs_width=700
zbxtg;graphs_height=300
zbxtg;graphs_period=1800
zbxtg;itemid:{ITEM.ID1}
zbxtg;title:{HOST.HOST} - {TRIGGER.NAME}
{{{TRIGGER.SEVERITY}}} {TRIGGER.NAME}
{{bomb}} {HOSTNAME} ({HOST.IP})
{{DISASTER}} {ITEM.VALUE1} ({TIME})

# –®–∞–±–ª–æ–Ω –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

{{OK}} {HOST.NAME} - {TRIGGER.STATUS}

zbxtg;graphs
zbxtg;graphs_width=700
zbxtg;graphs_height=300
zbxtg;graphs_period=1800
zbxtg;itemid:{ITEM.ID1}
zbxtg;title:{HOST.HOST} - {TRIGGER.NAME}
{{{TRIGGER.SEVERITY}}} {TRIGGER.NAME}
{{Information}} {HOSTNAME} ({HOST.IP})
{{time}} {DATE} {TIME}

## –ü–æ—è—Å–Ω–µ–Ω–∏—è

{{WARNING}} - –º–∞–∫—Ä–æ—Å –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ emoji —Å –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º
zbxtg;graphs - —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥—Ä–∞—Ñ–∏–∫
zbxtg;itemid:{ITEM.ID1} - –ø–∞—Ä–∞–º–µ—Ç—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç itemid –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏—Ç–µ–º–µ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ, –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–π itemid –≤—Ä—É—á–Ω—É—é
zbxtg;title - –∑–∞–¥–∞–µ—Ç –∏–º—è –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ–Ω—è—Ç–Ω–æ –ø–æ —Å–º—ã—Å–ª—É, —Ç–∞–∫ –∫–∞–∫ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –º–∞–∫—Ä–æ—Å–∞–º zabbix. –í–æ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:

zbxtg;graphs –≤–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤
zbxtg;graphs_period=10800 –ø–µ—Ä–∏–æ–¥ –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–æ–∏—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫
zbxtg;graphs_width=700 —à–∏—Ä–∏–Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞
zbxtg;graphs_height=300 –≤—ã—Å–æ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞
zbxtg;itemid:{ITEM.ID1} –≤—ã–±–æ—Ä itemid –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞
zbxtg;title:{HOST.HOST} - {TRIGGER.NAME} –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞
zbxtg;debug –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏, –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ tmp_dir
zbxtg;channel –≤–∫–ª—é—á–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –≤ telegram channel
zbxtg;to:username1,username2,username3 –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –≤ —à–∞–±–ª–æ–Ω–µ —É–∫–∞–∑–∞—Ç—å, –∫–æ–º—É –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
zbxtg;to_group:Group —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –≤—ã—à–µ, —Ç–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø

zbxtg.py

{ALERT.SENDTO}
{ALERT.SUBJECT}
{ALERT.MESSAGE}

emoji_map = {
"Disaster": "üî•",
"High": "üõë",
"Average": "‚ùó",
"Warning": "‚ö†Ô∏è",
"Information": "‚ÑπÔ∏è",
"Not classified": "üîò",
"OK": "‚úÖ",
"PROBLEM": "‚ùó",
"info": "‚ÑπÔ∏è",
"WARNING": "‚ö†Ô∏è",
"DISASTER": "‚ùå",
"bomb": "üí£",
"fire": "üî•",
"time": "‚è∞",
"hankey": "üí©",
}
